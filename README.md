# AstrBot 图像对称处理插件

>## 关于这个插件现在的状态...

今天零零碎碎改了不少东西，安全防护啊、各种限制啊都有了很多改进...  
**好消息是，现在的版本已经可以安全使用了！**

之前提交插件市场总被打回来，改完一个bug又冒出另一个...  
（就像打地鼠，一个bug下去，另一个又冒出来）

不过这次**真的修得差不多了**！核心功能正常，安全加固也到位了。  
今天搞了好几个小时，虽然累，但看着插件一点点完善还挺有成就感的。

### ⚠️ 重要安全提醒！

虽然我们做了很多防护，但用插件还是要**注意安全**：

1. **插件会访问用户提供的图片网址**  
   这个插件会下载用户提供的图片URL。虽然实现了多层防护，但**没有绝对的安全**：

→ 已实现的防护：
1. **私有网络拦截**：自动拒绝 `127.0.0.1`、`192.168.x.x`、`10.x.x.x` 等内网地址
2. **本地服务保护**：拦截 `localhost`、`.internal`、`.local` 等本地域名
3. **DNS安全**：使用固定解析器防止DNS重绑定攻击
4. **IP验证**：检查解析后的IP地址是否为私有地址

→ 理论上的风险（极低概率）：
- 如果用户的网络环境允许访问某些**非标准的内网服务地址**
- 某些**复杂的DNS攻击场景**可能绕过防护

→ 💡 使用建议：
- **可信环境**：在信任的群聊中使用是安全的
- **非关键服务器**：建议不要在运行重要服务的服务器上使用
- **网络隔离**：如果特别担心，可在网络隔离的环境中运行

> **技术说明**：插件的SSRF防护已覆盖常见攻击向量，普通使用场景下风险极低。

2. **插件会处理用户发的各种奇奇怪怪的图片**  
   → 我们加了大小限制（默认最大10MB图片/15MB GIF）  
   → 但如果你电脑配置太差，同时处理很多大图可能会卡  
   → **最好别让太多人同时用**，除非你服务器够猛

3. **插件会生成和删除临时文件**  
   → 所有文件都放在插件自己的数据目录里  
   → 1小时后自动清理（可以去web ui改插件配置，但是目前插件配置不生效，详见下文）  
   → 一般不会乱删你的系统文件

4. **配置系统不可用**
   - **现象**：配置项在WebUI中修改后不生效，即使修改，插件也会使用默认配置
   - **影响**：无法通过配置动态关闭某些功能
   - **可能原因**：配置加载逻辑有bug，或者配置值没有正确传递到业务代码
   - **求助**：熟悉AstrBot配置系统的大佬求帮忙看看！


### 📦 安全配置建议（给懂技术的小伙伴看）

- **生产环境**：建议打开 `silent_mode: true`（安静模式，不啰嗦）
- **文件大小**：如果服务器够强，可以在配置里调大 `image_size_limit_mb`
- **自动清理**：建议打开 `enable_auto_cleanup`，然后设个合适的 `keep_files_hours`
- **GIF处理**：如果怕卡，可以把 `enable_gif` 关掉

### ❗ 已知问题（需要大佬帮忙！）

1. **GIF不会动**：GIF图片对称处理后就变静态图了 😭  
   技术细节：好像是帧处理有问题，但我修不动了...
   
2. **内存泄漏没测**：用久了会不会内存爆炸？🤯 我还没测过！

3. **并发稳定性**：好多人同时发图的话，插件顶不顶得住？

4. **极端情况**：如果有人专门发些奇奇怪怪的图片来测试插件极限...

5. **配置系统问题**：插件配置项在WebUI中修改后不生效，即使修改，插件也会使用默认配置

6. **指令冲突导致重复回复**
   - **现象**：引用机器人自己发送的图片，然后发送不带`/`的对称指令（如"上对称"），机器人会**一次性回复两张处理后的图片**
   - **复现步骤**：
     1. 机器人发送一张图片
     2. 用户引用这张图片并发送"上对称"（不带斜杠）
     3. 机器人回复两张相同的对称图片
   - **问题根源**：新旧两套指令系统（带斜杠`/`和不带斜杠）同时工作，导致同一个请求被处理了两次
   - **技术细节**：
     ```python
     # 当前有两条处理路径：
     1. @filter.command("上对称")           # 原有的带斜杠指令系统
     2. @filter.event_message_type(ALL)   # 新增的无斜杠监听器
     
     # 两者都调用了同一个 process_mirror() 方法
     ```
   -这个问题以后修，当然大家可以帮忙就更好了！

**欢迎各位大佬来帮忙修复这些问题！** 特别是GIF不动的问题，我真的没招了...

---

### 那现在怎么办？

- **直接用**：现在这个版本应该可以正常工作，也有基本的安全防护
- **小心点用**：别在不信任的群里用，注意观察服务器状态
- **帮忙测试**：如果你发现了bug，欢迎提issue！

### 怎么参与改进？

- 直接提PR（Pull Request）就行
- 想改什么功能都行
- 修复bug、优化代码、加新功能...都可以

### 一点小提醒：

这个插件基本上都是AI写的+AI帮忙改bug  
所以代码里可能有些**注释没删干净**或者**可以再优化**的地方  
如果你看到了，帮忙清理一下哈~

**总之，欢迎大家一起来建设这个插件！** 

---

**一个为AstrBot设计的图像对称处理插件，专门生成各种"诡异"的对称图片，希望能给大家带来一点欢乐！**

## ✨ 功能特性

- **四种对称模式**：左对称、右对称、上对称、下对称
- **多图像源支持**：支持图片、GIF、QQ用户头像
- **智能解析**：自动识别回复消息中的图片
- **可配置**：用户可以自定义文件大小限制等参数
- **静默模式**：可选是否显示处理提示
- **自动清理**：自动清理临时文件，避免占用空间
- **诡异美学**：专门制造各种奇奇怪怪的对称图片！

## 🎮 指令列表

### 基础指令
| 指令 | 功能描述 |
|------|----------|
| `左对称` | 左半边图像对称到右边 |
| `右对称` | 右半边图像对称到左边 |
| `上对称` | 上半边图像对称到下面 |
| `下对称` | 下半边图像对称到上面 |
| `对称帮助` | 显示详细使用说明 |

## 📸 使用示例

### 方式1：回复图片消息
```
用户：(引用一张图片)左对称
机器人：[发送对称后的诡异图片]
```

### 方式2：处理@用户头像
```
用户：右对称 @张三
机器人：[发送张三头像的对称诡异版本]
```

### 方式3：同消息发送
```
用户：[图片] 上对称
机器人：[发送对称后的图片]
```

> **注意**：也支持传统的 `/指令` 格式，比如 `/左对称`

## 🤖 诡异效果展示

这个插件最适合制造：
- **恐怖对称脸**：把人的脸对称一下，制造恐怖谷效应
- **诡异表情包**：对称后的表情包往往效果"惊人"
- **鬼畜头像**：朋友的头像对称一下，制造搞笑效果

## ⚙️ 配置说明

插件支持以下可配置选项：

| 配置项 | 类型 | 默认值 | 描述 |
|--------|------|--------|------|
| 图像大小限制 (MB) | 数字 | 10 | 普通图像最大大小 |
| GIF大小限制 (MB) | 数字 | 15 | GIF动画最大大小 |
| 处理超时时间 (秒) | 数字 | 30 | 处理超时时间 |
| 输出图像质量 | 数字 | 85 | JPEG图像质量 (1-100) |
| 启用GIF处理 | 布尔 | true | 是否处理GIF动画 |
| 启用自动压缩 | 布尔 | true | 是否自动压缩图像 |
| 静默模式 | 布尔 | true | 是否显示处理提示 |
| 启用自动清理 | 布尔 | true | 是否自动清理文件 |
| 文件保留时间 (小时) | 数字 | 1 | 文件保留时间 |
| 启用@用户头像功能 | 布尔 | true | 是否支持@用户头像 |

## 📦 安装方法

### 方法1：从GitHub安装（推荐）
1. 进入AstrBot Web管理界面
2. 点击"插件市场"或"上传插件"
3. 输入GitHub仓库地址：`https://github.com/FenChen0211/astrbot-plugin-pic-mirror`
4. 点击安装

### 方法2：手动安装
1. [下载最新Release](https://github.com/FenChen0211/astrbot-plugin-pic-mirror/releases)
2. 在AstrBot插件管理界面选择"上传插件"
3. 选择下载的ZIP文件
4. 启用插件

## 🐛 已知问题与求助

### ❗ 需要社区帮助测试的问题：
1. **GIF不动**：GIF处理后就变静态图了 😭 急需大佬修复！
2. **内存泄漏**：还没测过！用久了会不会内存爆炸？🤯
3. **大文件处理**：超大图片/GIF处理稳定性
4. **并发处理**：多人同时使用时是否稳定

### 📝 如何反馈问题：
1. 在GitHub提Issue
2. 描述具体操作步骤
3. 提供错误日志（如果有）
4. 说明你的AstrBot版本

## 🛠️ 技术架构

```
astrbot-plugin-pic-mirror/
├── main.py # 主入口
├── core/ # 核心业务逻辑
│ ├── image_handler.py # 图像处理主逻辑
│ ├── avatar_service.py # QQ头像获取
│ └── cleanup_manager.py # 文件清理管理
├── utils/ # 工具函数
│ ├── file_utils.py # 文件操作
│ ├── network_utils.py # 网络请求
│ └── message_utils.py # 消息解析
├── services/ # 服务层
│ └── config_service.py # 配置管理
├── image_processor.py # 对称算法实现
├── config.py # 配置数据类
├── _conf_schema.json # 配置模式定义
└── metadata.yaml # 插件元数据
```

## 💻 开发说明

### 依赖
- Pillow >= 10.0.0 (图像处理)
- aiohttp >= 3.9.0 (网络请求)


## 🤝 贡献指南

欢迎任何形式的贡献！特别是：

1. **修复GIF问题**：求求了，这个我真的搞不定 😭
2. **测试报告**：帮我测试内存泄漏和稳定性
3. **Bug修复**：发现并修复问题
4. **功能建议**：有什么好玩的对称想法？
5. **代码优化**：AI写的代码可能有优化空间

### 贡献流程：
1. Fork 本仓库
2. 创建功能分支 (`git checkout -b feature/AmazingFeature`)
3. 提交更改 (`git commit -m 'Add some AmazingFeature'`)
4. 推送到分支 (`git push origin feature/AmazingFeature`)
5. 开启一个 Pull Request

## 🙏 致谢与说明

- **作者**：FenChen0211
- **代码编写**：完全由AI助手编写完成
- **安全审计**：经过多轮安全检查和加固
- **测试状态**：基本功能可用，但需要更多测试
- **初衷**：给大家带来一点欢乐，制造有趣的对称图片

> 特别感谢：所有帮忙测试的朋友！如果发现内存泄漏问题，请温柔地告诉我... 

## 🌟 最后的话

虽然这是个"AI编写、高中生维护、GIF还不会动"的三无产品，但希望它能给你带来一些乐趣！如果你用它制造出了特别诡异的图片，欢迎分享！喜欢的话请给我点一个Star！

**祝大家玩得开心，制造出更多奇奇怪怪的对称图片！** 🎉👻

---

*PS: 如果这个版本还有什么问题导致上不了插件市场... 那我真的会哭的 😂*